# 空字节填充从而泄露敏感信息

> 原题：Filling in the Blanks: Exploiting Null Byte Buffer Overflow for a $40,000 Bounty
>
> 原文：[Exploiting Null Byte Buffer Overflow for a ,000 bounty | Sam Curry](https://samcurry.net/filling-in-the-blanks-exploiting-null-byte-buffer-overflow-for-a-40000-bounty/)
>

## 异象

当我最初启动应用程序时，我想到了通过使用一些字符串操作技巧将受害者的帐户重新注册到平台。其主要思想是将帐户用户名改为“受害者”加上一个将被删除的字符（例如：空字节，CRLF 字符，空格，特殊的 Unicode 字符 等等）。

因为我猜测在登陆的过程里传输的不同参数将会传递给不同的函数，而在这过程中参数结尾的某些符号将会被移除。

如果我的猜想正确的话应该会发生这样一个过程：

![img](https://secureservercdn.net/198.71.233.71/623.f31.myftpupload.com/wp-content/uploads/2019/11/Untitled-Diagram-2.png)

并且如果在登录过程中这个过程发生了，攻击者将会已 `victim` 的账号登录成功。

尽管这个尝试并没有成功，我觉的它依然是可以分享的因为这对理解我接下来的攻击手法非常有用。

我最初尝试使用以下邮箱进行注册，因为如果空字节被删除了，那么我注册的邮箱就会覆盖掉 victim 用户的邮箱地址。

```
victim%00@domain.com
```

请求发送成功，但奇怪的是我注册的邮箱名字变成了下面这样：

```
victimL@domain.com
```

应该是服务器因为某些原因将 `%00` 改为了 `L` 。感觉到很奇怪所以进行了接下来的尝试，看看这种想想是否会再次发生并且验证当出现多个空字节符号时会发生什么。

```
victim%00%00%00@domain.com
```

结果新注册的邮箱名变成了这样：

```
victimIdL@domain.com
```

看起来好像空字节被替换成了随机的数据，然后我尝试发送尽可能多的数据，因为 POST 数据包没有限制 body 部分的大小，所以我发送了大量的数据，以至于等了10秒钟才等到返回包。

在仔细观察返回包的内容，看到了很多大量的可读的数据，我把同样的数据包又发送了一遍，然后得到了一个相似但又不同的新的返回包，返回包的内容包括 RSA 密钥、内部 HTTP 请求、用户磁盘内容、用户名和密码的初始文本以及大量其他的秘密内容。

## 原因

起初我们并不知道发生了什么，因为这现象发生的太奇怪了。我们认为这或许是某种内存损坏或者缓冲区溢出，但这么解释也很奇怪因为我们使用的是多个空字节。

最终发现其实真正的原因和 `Sergey Belov `在 twitter 中描述的一样：前端应用程序将参数传递给了以 C语言 不安全函数实现的后端处理程序里。

事实上，在这个传递过程中，C语言实现的后端需要得到两个数据：

- 字符串
- 字符串长度

如果发送 `abc%00` 到后端，前端应用程序将会判断为：

- 字符串：abd%00
- 字符串长度：4

如果整个过程全由前端进行，这完全正常，但是实际上参数还有一个传递到后端的过程，在传递中空字节被移除，这是后端接收到的信息成了：

- 字符串：abc
- 字符串长度：4

对 C语言有所了解的人就会知道，在前端长度计算时将空字节也计算在内了，但是在后端接收到的信息里，**多了长度但是却没有足够多的内容**。当攻击者在请求时填入大量的空字节，即传输信息中的字符串长度远大于实际字符串长度，这时**后端在读入数据时会留下字符串长度大小的内存空间供数据接收，而实际接收到的字符串内容远小于长度，这使得该块内存原有的数据未被有效覆盖。这之后后端按长度返回信息时就返回了大量原内存块中的信息**，因此大量有用信息被泄露。

大概流程如图所示：

![img](https://secureservercdn.net/198.71.233.71/623.f31.myftpupload.com/wp-content/uploads/2019/11/Untitled-Diagram.png)

这就允许了攻击者通过简单的重复发送含有大量空字节的请求包来获得多达兆字节的信息。下图便是比较形象的例子：

![img](https://secureservercdn.net/198.71.233.71/623.f31.myftpupload.com/wp-content/uploads/2019/12/chart_123.png)

